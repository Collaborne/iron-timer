<!doctype html>
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../moment-element/moment-import.html">

<!--
A simple countdown timer

### Example

```html
<iron-timer start-time="00:00:05" current-time="{{currentTime}}"></iron-timer>
```

@demo demo/index.html
-->
<dom-module id="iron-timer">
</dom-module>

<script>

(function() {

	Polymer({
		is: 'iron-timer',
		properties: {
			/**
			 * Start time for the timer, in format HH:mm:ss
			 * @default 00:00:00
			 */
			startTime: {
				type: String,
				value: '00:00:00'
			},
			/**
			 * Current time of the timer, in format HH:mm:ss
			 */
			currentTime: {
				type: String,
				notify: true
			},
			isRunning: {
				type: Boolean,
				value: false
			},
			_elapsed:{
				type: Number,
				value: 0
			},
			_timer: Object
		},
		ready: function() {
			this.set('currentTime', this.startTime);
		},
		/**
		 * Starts the timer from the provided startTime
		 */
		start: function() {
			if (!this.startTime) {
				// TODO: what should happen when timer is started without startTime?
				return;
			}
			this._timer = moment(this.currentTime, 'HH:mm:ss');
			this.isRunning = true;

			window.requestAnimationFrame(this._decreaseTimer.bind(this));
		},
		/**
		 * Pauses the timer
		 */
		pause: function() {
			this.isRunning = false;
			this._elapsed = 0;
		},
		/**
		 * Resumes the timer from where it has been paused
		 */
		resume: function() {
			if (!this.startTime || this.isRunning) {
				// TODO: what should happen when timer is started without startTime?
				return;
			}
			// check if the timer has started at all, or it's over.
			if (this.currentTime === '00:00:00' || this.currentTime === this.startTime) {
				return;
			}
			this.isRunning = true;
			window.requestAnimationFrame(this._decreaseTimer.bind(this));
		},
		/**
		 * Resets the timer to the provided startTime
		 */
		reset: function() {
			this.currentTime = this.startTime;
			this._timer = moment(this.currentTime, 'HH:mm:ss');
			this._elapsed = 0;
		},
		_decreaseTimer: function(timestamp) {
			if (!this.isRunning) {
				return;
			}
			if (this.currentTime === '00:00:00') {
				// timer is over
				this.pause();
				this.fire('iron-timer-end');
				return;
			}
			if (this._elapsed === 0) {
				this._elapsed = timestamp;
			}
			progress = timestamp - this._elapsed;

			if (progress >= 1000) {
				this.currentTime = this._timer.subtract(1, 's').format('HH:mm:ss');
				this._elapsed = timestamp;
			}
			window.requestAnimationFrame(this._decreaseTimer.bind(this));
		}
	});

})();

</script>
